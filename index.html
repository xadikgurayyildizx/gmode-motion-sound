<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>G-MODE Hareket → Ses</title>
<style>
  html,body{margin:0;padding:0;background:#000;color:#0f0;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #ui{
    position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
    display:flex;gap:10px;align-items:center;
    background:rgba(0,0,0,0.75);padding:10px 12px;border-radius:12px
  }
  #ui button{
    background:#0f0;color:#000;border:0;border-radius:10px;
    padding:10px 12px;font-weight:700
  }
  #ui span{font-size:12px;opacity:.9}
  video,canvas{display:none}
</style>
</head>
<body>

<div id="ui">
  <button id="startBtn">START SOUND</button>
  <span>Kamera + elini hareket ettir</span>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="c"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let audioCtx, osc, gain, filter;
let lastFrame = null;
let started = false;

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:true });
  video.srcObject = stream;
}

function startAudio(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  osc = audioCtx.createOscillator();
  gain = audioCtx.createGain();
  filter = audioCtx.createBiquadFilter();

  osc.type = "sawtooth";
  filter.type = "lowpass";

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);

  gain.gain.value = 0;
  osc.start();

  requestAnimationFrame(loop);
}

function loop(){
  if (!video.videoWidth || !video.videoHeight){
    requestAnimationFrame(loop);
    return;
  }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);

  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);

  if(lastFrame){
    let diff = 0;
    for(let i=0;i<frame.data.length;i+=4){
      diff += Math.abs(frame.data[i] - lastFrame.data[i]);
    }

    let motion = diff / 500000;
    if (motion > 1) motion = 1;

    const freq = 120 + motion * 600;
    const cutoff = 400 + motion * 3000;

    osc.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.05);
    filter.frequency.setTargetAtTime(cutoff, audioCtx.currentTime, 0.05);
    gain.gain.setTargetAtTime(0.05 + motion*0.2, audioCtx.currentTime, 0.05);
  }

  lastFrame = frame;
  requestAnimationFrame(loop);
}

document.getElementById("startBtn").addEventListener("click", async () => {
  if (started) return;
  started = true;
  try{
    await startCamera();
    startAudio();
    document.getElementById("startBtn").textContent = "SOUND ON";
  }catch(e){
    document.getElementById("startBtn").textContent = "KAMERA İZNİ?";
    started = false;
  }
});
</script>

</body>
</html>
